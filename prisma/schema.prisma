// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(uuid())
  phoneNumber     String    @unique @map("phone_number")
  name            String
  email           String?
  isPrimaryUser   Boolean   @default(false) @map("is_primary_user")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  contacts        Contact[]
  ownedLists      List[]
  sharedLists     ListShare[]
  locations       Location[]
  trips           Trip[]
  settings        UserSetting[]
  permissionsGranted Permission[] @relation("GrantedPermissions")
  permissionsReceived Permission[] @relation("ReceivedPermissions")
  listItemsAdded  ListItem[]

  @@map("users")
}

model Contact {
  id           String    @id @default(uuid())
  ownerId      String    @map("owner_id")
  name         String
  phoneNumber  String?   @map("phone_number")
  email        String?
  relationship String?
  notes        String?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  owner        User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([ownerId, name])
  @@map("contacts")
}

model Permission {
  id               String    @id @default(uuid())
  userId           String    @map("user_id")
  grantedByUserId  String    @map("granted_by_user_id")
  permissionType   String    @map("permission_type")
  isActive         Boolean   @default(true) @map("is_active")
  createdAt        DateTime  @default(now()) @map("created_at")
  expiresAt        DateTime? @map("expires_at")

  user             User      @relation("ReceivedPermissions", fields: [userId], references: [id], onDelete: Cascade)
  grantedBy        User      @relation("GrantedPermissions", fields: [grantedByUserId], references: [id], onDelete: Cascade)

  @@unique([userId, grantedByUserId, permissionType])
  @@index([userId])
  @@index([grantedByUserId])
  @@map("permissions")
}

model List {
  id        String    @id @default(uuid())
  ownerId   String    @map("owner_id")
  name      String
  type      String    @default("general")
  isShared  Boolean   @default(false) @map("is_shared")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  owner     User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  items     ListItem[]
  shares    ListShare[]

  @@index([ownerId])
  @@map("lists")
}

model ListItem {
  id            String    @id @default(uuid())
  listId        String    @map("list_id")
  content       String
  isCompleted   Boolean   @default(false) @map("is_completed")
  quantity      String?
  addedByUserId String?   @map("added_by_user_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  completedAt   DateTime? @map("completed_at")

  list          List      @relation(fields: [listId], references: [id], onDelete: Cascade)
  addedBy       User?     @relation(fields: [addedByUserId], references: [id])

  @@index([listId])
  @@map("list_items")
}

model ListShare {
  id               String   @id @default(uuid())
  listId           String   @map("list_id")
  sharedWithUserId String   @map("shared_with_user_id")
  canEdit          Boolean  @default(true) @map("can_edit")
  createdAt        DateTime @default(now()) @map("created_at")

  list             List     @relation(fields: [listId], references: [id], onDelete: Cascade)
  sharedWith       User     @relation(fields: [sharedWithUserId], references: [id], onDelete: Cascade)

  @@unique([listId, sharedWithUserId])
  @@index([listId])
  @@index([sharedWithUserId])
  @@map("list_shares")
}

model Location {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  latitude       Decimal  @db.Decimal(10, 8)
  longitude      Decimal  @db.Decimal(11, 8)
  address        String?
  label          String?
  isCurrent      Boolean  @default(true) @map("is_current")
  accuracyMeters Int?     @map("accuracy_meters")
  createdAt      DateTime @default(now()) @map("created_at")

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isCurrent])
  @@index([createdAt])
  @@map("locations")
}

model Trip {
  id                 String    @id @default(uuid())
  userId             String    @map("user_id")
  originLat          Decimal?  @map("origin_lat") @db.Decimal(10, 8)
  originLng          Decimal?  @map("origin_lng") @db.Decimal(11, 8)
  originAddress      String?   @map("origin_address")
  destinationLat     Decimal   @map("destination_lat") @db.Decimal(10, 8)
  destinationLng     Decimal   @map("destination_lng") @db.Decimal(11, 8)
  destinationAddress String    @map("destination_address")
  destinationLabel   String?   @map("destination_label")
  estimatedArrival   DateTime? @map("estimated_arrival")
  status             String    @default("active")
  createdAt          DateTime  @default(now()) @map("created_at")
  completedAt        DateTime? @map("completed_at")

  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, status])
  @@map("trips")
}

model MessageLog {
  id          String   @id @default(uuid())
  fromPhone   String   @map("from_phone")
  toPhone     String   @map("to_phone")
  messageBody String   @map("message_body")
  direction   String
  twilioSid   String?  @map("twilio_sid")
  status      String?
  intent      String?
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([fromPhone, createdAt])
  @@index([createdAt])
  @@map("message_log")
}

model UserSetting {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  settingKey   String   @map("setting_key")
  settingValue String?  @map("setting_value")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, settingKey])
  @@index([userId])
  @@map("user_settings")
}
